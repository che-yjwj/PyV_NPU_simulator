# PyV-NPU 아키텍처 분석 및 개선 논의 (메모리 및 클럭)

v250820
작성자: Gemini

본 문서는 PyV-NPU 시뮬레이터의 메모리 계층, 클럭 구조에 대한 분석과 향후 개선 방향에 대한 논의를 요약합니다.

## 1. 메모리 계층 분석

### 1.1. 현재 메모리 구조
시뮬레이터는 NPU 가속기에서 보편적인 **SPM(Scratchpad Memory) 중심의 계층 구조**를 가집니다.

- **DRAM**: 주 메모리
- **NoC (Network-on-Chip)**: DRAM과 NPU 클러스터 간의 인터커넥트
- **DMA (Direct Memory Access)**: DRAM-SPM 간 데이터 전송 유닛
- **SPM (Scratchpad Memory)**: NPU 클러스터 내의 고속 메모리. 여러 개의 **뱅크(Bank)**로 구성되어 동시 접근을 통한 성능 향상을 모델링하며, 소프트웨어(컴파일러/스케줄러)에 의해 명시적으로 제어됩니다.

### 1.2. TC-VC 데이터 전송 경로
- **공유 SPM 사용**: Tensor Core(TC)과 Vector Core(VC)은 데이터를 **공유 SPM**을 통해 주고받습니다.
- **데이터 흐름**: TC가 연산 결과를 SPM에 쓰면, 스케줄러가 VC에게 해당 데이터의 주소를 알려주어 다음 연산을 수행하게 하는 유연한 Producer-Consumer 모델을 따릅니다.

### 1.3. 시뮬레이션 레벨별 메모리 모델
- **IA (기능 정확성)**: 타이밍이 없는 추상적인 메모리 모델을 사용합니다.
- **IA_TIMING (명령어+타이밍)**: DRAM-SPM 간 데이터 이동 시간을 개략적으로 모델링합니다.
- **CA_HYBRID (이벤트/자원)**: `BandwidthTracker`(대역폭 제한), `BankTracker`(뱅크 충돌) 등을 포함한 가장 정교한 메모리 모델을 사용합니다.

## 2. 캐시 시스템 분석 및 도입 권장

### 2.1. L1 캐시의 부재 및 추가 제안
- **현황**: 현재 `Py-V` RISC-V CPU 모델에는 L1 캐시가 구현되어 있지 않습니다. 이는 개발 초기 단계에서 CPU 파이프라인의 복잡도를 낮추고 NPU 시뮬레이션 자체에 집중하기 위한 설계로 보입니다.
- **추가 필요성**: L1 캐시 추가는 매우 현실적이고 필요한 작업입니다. Py-V의 모듈식 설계를 활용하여 `L1Cache` 모듈을 새로 구현하고 CPU 모델에 연결할 수 있습니다.

### 2.2. L1 캐시 도입 시 성능 영향
- **Loose-Coupled 모드**: NPU 작업 준비 시간이 단축되지만, 전체 성능에 미치는 영향은 제한적입니다. 다만 시뮬레이션의 정확도는 향상됩니다.
- **Tight-Coupled 모드**: **영향이 결정적이고 필수적입니다.** L1 캐시는 커스텀 명령어(`ENQCMD_T`)의 제출 지연 시간을 최소화하고, CPU와 NPU 간의 세밀한 상호작용을 가능하게 하며, 시스템의 실제 병목을 정확히 분석하기 위한 전제 조건입니다.

### 2.3. L2 캐시 및 추가 계층 도입 제안
- **L2 캐시**: PRD에 이미 `L2/CCx`가 명시된 만큼, 하드웨어 관리형 L2 캐시 도입을 **적극적으로 추천합니다.** 이는 불규칙한 메모리 접근 패턴에 대응하고, SPM과의 성능을 비교 분석하는 중요한 연구 주제가 될 것입니다.
- **다양한 계층 구조**: 연구용 시뮬레이터의 가치를 높이기 위해 아래와 같은 추가 계층 도입을 제안합니다.
    1. **L1 캐시**: `Py-V` 코어에 우선적으로 추가하여 CPU 모델의 현실성을 높입니다.
    2. **L3 공유 캐시**: CPU와 NPU 클러스터가 공유하는 L3 캐시를 도입하여 시스템 전체의 데이터 흐름과 성능을 분석합니다.
    3. **다양한 DRAM 모델**: HBM, LPDDR 등 다른 DRAM 규격의 특성을 모델링하여 교체하며 분석할 수 있도록 확장합니다.

## 3. 클럭 구조 분석

- **현재 구조**: 시뮬레이터는 현재 모든 컴포넌트(CPU, TC, VC)가 **1.2 GHz라는 단일 클럭 속도**를 공유하는 것으로 단순화되어 있습니다.
- **개선 제안**: 실제 SoC는 전력과 성능 최적화를 위해 각기 다른 클럭으로 동작하는 **비동기 클럭 도메인**을 가집니다. 향후 시뮬레이터의 정확도를 높이기 위해 CPU, TC, VC가 독립적인 클럭 속도를 갖도록 시스템을 확장하는 것을 강력히 추천합니다.
